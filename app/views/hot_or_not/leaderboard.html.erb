<% content_for :title do %>
  Leaderboard
<% end %>

<div class="leaderboard-container">
  <h1>Leaderboard</h1>

  <div class="leaderboard-section">
    <h2>Top Resolvers</h2>
    <p class="section-description">Users who have resolved the most patches</p>
    <% if @top_resolvers.any? %>
      <table class="leaderboard-table">
        <thead>
          <tr>
            <th>Rank</th>
            <th>User</th>
            <th>Resolved</th>
            <th>Fixed</th>
            <th>Invalid</th>
          </tr>
        </thead>
        <tbody>
          <% @top_resolvers.each_with_index do |row, index| %>
            <tr class="<%= 'current-user' if row.user_id == current_user&.id %>">
              <td class="rank"><%= index + 1 %></td>
              <td class="username">
                <a href="/hot-or-not/users/<%= ERB::Util.url_encode(row.username) %>"><%= row.username %></a>
              </td>
              <td class="count"><%= row.resolved_count %></td>
              <td class="count resolved-fixed"><%= row.fixed_count %></td>
              <td class="count resolved-invalid"><%= row.invalid_count %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p class="empty-message">No patches resolved yet.</p>
    <% end %>
  </div>

  <div class="leaderboard-section">
    <h2>Top Raters</h2>
    <% if @top_raters.any? %>
      <table class="leaderboard-table">
        <thead>
          <tr>
            <th>Rank</th>
            <th>User</th>
            <th>Ratings</th>
          </tr>
        </thead>
        <tbody>
          <% @top_raters.each_with_index do |user, index| %>
            <tr class="<%= 'current-user' if user.id == current_user&.id %>">
              <td class="rank"><%= index + 1 %></td>
              <td class="username">
                <a href="/hot-or-not/users/<%= ERB::Util.url_encode(user.username) %>"><%= user.username %></a>
              </td>
              <td class="count"><%= user.rating_count %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p class="empty-message">No ratings yet. Be the first!</p>
    <% end %>
  </div>

  <div class="leaderboard-section">
    <h2>Hottest Patches</h2>
    <% if @hottest_patches.any? %>
      <div class="patch-list">
        <% @hottest_patches.each_with_index do |patch, index| %>
          <a href="/hot-or-not/<%= patch.id %>" class="patch-list-item">
            <span class="patch-rank"><%= index + 1 %></span>
            <span class="patch-info">
              <span class="patch-name"><%= patch.title.sub(/^Audit Fix:\s*/i, '').truncate(70) %></span>
              <span class="patch-meta-line">
                <code><%= patch.commit_hash[0..7] %></code>
                <% if patch.issue_type.present? %>
                  <span class="badge badge-<%= patch.issue_type %>"><%= patch.issue_type %></span>
                <% end %>
                <%= committer_link(patch, css_class: "committer-badge") %>
              </span>
            </span>
            <span class="patch-score hot"><%= patch.hot_ratio %>%</span>
          </a>
        <% end %>
      </div>
    <% else %>
      <p class="empty-message">No patches rated yet.</p>
    <% end %>
  </div>

  <div class="leaderboard-section">
    <h2>Most Controversial</h2>
    <p class="section-description">Patches with the most divided opinions (closest to 50/50)</p>
    <% if @most_controversial.any? %>
      <div class="patch-list">
        <% @most_controversial.each_with_index do |patch, index| %>
          <a href="/hot-or-not/<%= patch.id %>" class="patch-list-item">
            <span class="patch-rank"><%= index + 1 %></span>
            <span class="patch-info">
              <span class="patch-name"><%= patch.title.sub(/^Audit Fix:\s*/i, '').truncate(70) %></span>
              <span class="patch-meta-line">
                <code><%= patch.commit_hash[0..7] %></code>
                <span class="split-votes"><%= patch.hot_count %> HOT / <%= patch.not_count %> NOT</span>
                <%= committer_link(patch, css_class: "committer-badge") %>
              </span>
            </span>
            <span class="patch-score split"><%= patch.hot_ratio %>%</span>
          </a>
        <% end %>
      </div>
    <% else %>
      <p class="empty-message">Need more votes for controversial rankings.</p>
    <% end %>
  </div>

  <div class="leaderboard-section">
    <h2>Top Committers</h2>
    <p class="section-description">Committers whose patches are rated hottest on average</p>
    <% if @top_committers.any? %>
      <table class="leaderboard-table">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Committer</th>
            <th>Patches</th>
            <th>Votes</th>
            <th>Avg Approval</th>
          </tr>
        </thead>
        <tbody>
          <% @top_committers.each_with_index do |row, index| %>
            <tr>
              <td class="rank"><%= index + 1 %></td>
              <td class="username">
                <a href="/hot-or-not/by/<%= ERB::Util.url_encode(row.committer_identifier) %>"><%= row.committer_identifier %></a>
              </td>
              <td class="count"><%= row.patch_count %></td>
              <td class="count"><%= row.total_votes %></td>
              <td class="approval hot"><%= (row.avg_hot_ratio * 100).round(1) %>%</td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p class="empty-message">No committer data available yet.</p>
    <% end %>
  </div>

  <% if @user_stats %>
    <div class="your-stats">
      <h2>Your Progress</h2>
      <div class="stat-grid">
        <div class="stat-item">
          <span class="stat-value"><%= @user_stats[:total_rated] %></span>
          <span class="stat-label">Rated</span>
        </div>
        <div class="stat-item">
          <span class="stat-value"><%= @user_stats[:remaining] %></span>
          <span class="stat-label">Remaining</span>
        </div>
      </div>
      <% if @user_stats[:remaining] > 0 %>
        <a href="/hot-or-not" class="btn-primary">Keep Rating!</a>
      <% end %>
    </div>
  <% end %>
</div>
