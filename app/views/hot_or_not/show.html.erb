<% content_for :title do %>
  Rate: <%= @patch.title.sub(/^Audit Fix:\s*/i, '').truncate(50) %>
<% end %>

<div class="patch-container">
  <div class="patch-nav-top">
    <% if @prev_patch %>
      <a href="/hot-or-not/<%= @prev_patch.id %>" class="nav-btn nav-prev">&larr; Prev</a>
    <% else %>
      <span class="nav-btn nav-prev disabled">&larr; Prev</span>
    <% end %>

    <a href="/hot-or-not" class="nav-btn nav-random">Random Unrated</a>

    <% if @next_patch %>
      <a href="/hot-or-not/<%= @next_patch.id %>" class="nav-btn nav-next">Next &rarr;</a>
    <% else %>
      <span class="nav-btn nav-next disabled">Next &rarr;</span>
    <% end %>
  </div>

  <div class="patch-header">
    <div class="patch-meta">
      <a href="<%= @patch.github_commit_url %>" target="_blank" rel="noopener" class="commit-link">
        <code><%= @patch.commit_hash %></code>
      </a>
      <% if @patch.issue_type.present? %>
        <span class="issue-type issue-type-<%= @patch.issue_type %>"><%= @patch.issue_type %></span>
      <% end %>
      <% if @patch.resolved? %>
        <span class="resolution-badge resolution-<%= @patch.resolution_status %>">
          <%= @patch.resolution_status.upcase %>
        </span>
      <% end %>
      <% if @patch.audit_date.present? %>
        <span class="audit-date">Audited: <%= @patch.audit_date.strftime("%Y-%m-%d") %></span>
      <% end %>
      <% if has_committer?(@patch) %>
        <span class="committer">by <%= committer_link(@patch) %></span>
      <% end %>
    </div>
    <h1 class="patch-title"><%= @patch.title.sub(/^Audit Fix:\s*/i, '') %></h1>
  </div>

  <% if @patch.resolved? %>
    <div class="resolution-info">
      <p>
        <strong>Resolved as <%= @patch.resolution_status %></strong>
        by <% if @patch.resolved_by&.username.present? %><a href="/hot-or-not/users/<%= ERB::Util.url_encode(@patch.resolved_by.username) %>"><%= @patch.resolved_by.username %></a><% else %>Unknown<% end %>
        on <%= @patch.resolved_at.strftime("%Y-%m-%d") %>
      </p>
      <% if @patch.resolution_changeset_url.present? %>
        <p class="resolution-changeset">
          <strong>Changeset:</strong>
          <a href="<%= @patch.resolution_changeset_url %>" target="_blank" rel="noopener"><%= @patch.resolution_changeset_url %></a>
        </p>
      <% end %>
      <% if @patch.resolution_notes.present? %>
        <p class="resolution-notes"><%= @patch.resolution_notes %></p>
      <% end %>
    </div>
  <% end %>

  <% if @patch.summary.present? %>
    <div class="patch-summary">
      <h3>Summary</h3>
      <p><%= @patch.summary %></p>
    </div>
  <% end %>

  <div class="patch-diff">
    <div class="diff-header-row">
      <h3>Diff</h3>
      <div class="diff-actions">
        <button type="button" class="copy-curl-btn" data-patch-id="<%= @patch.id %>">
          Copy curl command
        </button>
        <a href="/hot-or-not/<%= @patch.id %>/download" class="download-patch">Download .patch</a>
      </div>
    </div>
    <pre class="diff-view"><code><%= highlight_diff(@patch.diff_content) %></code></pre>
  </div>

  <% if @patch.markdown_content.present? %>
    <details class="full-analysis">
      <summary>View Full Analysis</summary>
      <div class="analysis-content">
        <%= PrettyText.cook(@patch.markdown_content).html_safe %>
      </div>
    </details>
  <% end %>

  <% if @is_reviewer && !@patch.resolved? %>
    <div class="reviewer-actions">
      <h3>Reviewer Actions</h3>
      <div class="claim-buttons">
        <% if @patch.claimed_by?(current_user) %>
          <%= form_tag("/hot-or-not/#{@patch.id}/unclaim", method: :delete, style: "display: inline") do %>
            <button type="submit" class="unclaim-btn">Unclaim</button>
          <% end %>
        <% else %>
          <%= form_tag("/hot-or-not/#{@patch.id}/claim", method: :post, style: "display: inline") do %>
            <button type="submit" class="claim-btn">Claim</button>
          <% end %>
        <% end %>
      </div>

      <div class="resolve-buttons">
        <button type="button" class="resolve-btn resolve-btn-fixed" id="open-resolve-modal">Resolve as Fixed</button>
        <%= form_tag("/hot-or-not/#{@patch.id}/resolve", method: :post, style: "display: inline") do %>
          <%= hidden_field_tag :status, "invalid" %>
          <button type="submit" class="resolve-btn resolve-btn-invalid">Resolve as Invalid</button>
        <% end %>
      </div>

      <% claims = @patch.patch_claims.includes(:user) %>
      <% if claims.any? %>
        <div class="current-claims">
          <p><strong>Claimed by:</strong></p>
          <ul>
            <% claims.each do |claim| %>
              <li><a href="/hot-or-not/users/<%= ERB::Util.url_encode(claim.user.username) %>"><%= claim.user.username %></a></li>
            <% end %>
          </ul>
        </div>
      <% end %>
    </div>
  <% end %>

  <% if @patch.resolved? && current_user&.admin? %>
    <div class="admin-actions">
      <%= form_tag("/hot-or-not/#{@patch.id}/unresolve", method: :post, style: "display: inline") do %>
        <button type="submit" class="btn-secondary">Clear Resolution (Admin)</button>
      <% end %>
    </div>
  <% end %>

  <div class="rating-section">
    <% if @patch.resolved? %>
      <div class="voting-disabled">
        <p>Voting is disabled for resolved patches.</p>
        <p class="rating-stats">
          <span class="hot-count"><%= @patch.hot_count %> HOT</span>
          <span class="not-count"><%= @patch.not_count %> NOT</span>
          <span class="hot-ratio">(<%= @patch.hot_ratio %>% approval)</span>
        </p>
      </div>
    <% elsif @user_rating %>
      <div class="already-rated">
        <p>You rated this patch: <strong class="<%= @user_rating.is_hot ? 'vote-hot' : 'vote-not' %>"><%= @user_rating.is_hot ? "HOT" : "NOT" %></strong></p>
        <p class="rating-stats">
          <span class="hot-count"><%= @patch.hot_count %> HOT</span>
          <span class="not-count"><%= @patch.not_count %> NOT</span>
          <span class="hot-ratio">(<%= @patch.hot_ratio %>% approval)</span>
        </p>
        <p class="change-vote-label">Change your vote:</p>
      </div>

      <div class="rating-buttons">
        <%= form_tag("/hot-or-not/#{@patch.id}/rate", method: :post, style: "display: inline") do %>
          <%= hidden_field_tag :is_hot, "true" %>
          <button type="submit" class="rate-btn rate-hot <%= 'selected' if @user_rating&.is_hot %>">HOT</button>
        <% end %>
        <%= form_tag("/hot-or-not/#{@patch.id}/rate", method: :post, style: "display: inline") do %>
          <%= hidden_field_tag :is_hot, "false" %>
          <button type="submit" class="rate-btn rate-not <%= 'selected' if @user_rating && !@user_rating.is_hot %>">NOT</button>
        <% end %>
      </div>
    <% else %>
      <h3>What do you think?</h3>

      <div class="rating-buttons">
        <%= form_tag("/hot-or-not/#{@patch.id}/rate", method: :post, style: "display: inline") do %>
          <%= hidden_field_tag :is_hot, "true" %>
          <button type="submit" class="rate-btn rate-hot">HOT</button>
        <% end %>
        <%= form_tag("/hot-or-not/#{@patch.id}/rate", method: :post, style: "display: inline") do %>
          <%= hidden_field_tag :is_hot, "false" %>
          <button type="submit" class="rate-btn rate-not">NOT</button>
        <% end %>
      </div>
    <% end %>
  </div>

  <div class="patch-progress">
    <p>
      <strong><%= @user_stats[:total_rated] %></strong> rated
      &bull;
      <strong><%= @user_stats[:remaining] %></strong> remaining
    </p>
  </div>
</div>

<% if @is_reviewer && !@patch.resolved? %>
<div id="resolve-modal" class="modal-overlay" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Resolve as Fixed</h3>
      <button type="button" class="modal-close" data-close-modal>&times;</button>
    </div>
    <%= form_tag("/hot-or-not/#{@patch.id}/resolve", method: :post) do %>
      <%= hidden_field_tag :status, "fixed" %>
      <div class="modal-body">
        <div class="form-group">
          <label for="changeset_url">Changeset URL <span class="required">(required)</span></label>
          <%= text_field_tag :changeset_url, nil, placeholder: "https://github.com/discourse/discourse/commit/...", class: "form-input", required: true %>
          <p class="form-help">Link to the commit or PR that fixes this issue</p>
        </div>
        <div class="form-group">
          <label for="notes">Notes <span class="optional">(optional)</span></label>
          <%= text_area_tag :notes, nil, placeholder: "Any additional notes about the fix...", class: "form-input", rows: 3 %>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-secondary" data-close-modal>Cancel</button>
        <button type="submit" class="resolve-btn resolve-btn-fixed">Resolve as Fixed</button>
      </div>
    <% end %>
  </div>
</div>
<% end %>
